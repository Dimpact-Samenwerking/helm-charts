{{- if .Values.keycloak.keycloakConfigCli.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.keycloak.keycloakConfigCli.existingConfigmap }}
  labels:
    {{- include "podiumd.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak-config-cli
data:
  realm.yaml: |
      enabled: true
      realm: podiumd
      displayName: {{ required ".Values.keycloak.config.realmDisplayName is missing" .Values.keycloak.config.realmDisplayName | quote }}
      loginWithEmailAllowed: true
      rememberMe: true
      attributes:
        frontendUrl: {{ required ".Values.keycloak.config.realmFrontendUrl is missing" .Values.keycloak.config.realmFrontendUrl | quote }}
      clients:
        {{- if .Values.openzaak.enabled }}
        - clientId: openzaak
          name: Open Zaak
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.openzaakUrl is missing" .Values.global.configuration.openzaakUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.openzaakUrl }}/*"
          secret: {{ required ".Values.openzaak.configuration.oidcSecret" .Values.openzaak.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.opennotificaties.enabled }}
        - clientId: opennotificaties
          name: Open Notificaties
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.opennotificatiesUrl is missing" .Values.global.configuration.opennotificatiesUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.opennotificatiesUrl }}/*"
          secret: {{ required ".Values.opennotificaties.configuration.oidcSecret is missing" .Values.opennotificaties.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.objecten.enabled }}
        - clientId: objecten
          name: Objecten
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.objectenUrl is missing" .Values.global.configuration.objectenUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.objectenUrl }}/*"
          secret: {{ required ".Values.objecten.configuration.oidcSecret is missing" .Values.objecten.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.objecttypen.enabled }}
        - clientId: objecttypen
          name: Objecttypen
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.objecttypenUrl is missing" .Values.global.configuration.objecttypenUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.objecttypenUrl }}/*"
          secret: {{ required ".Values.objecttypen.configuration.oidcSecret is missing" .Values.objecttypen.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.openforms.enabled }}
        - clientId: openforms
          name: Open Forms
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.openformsUrl is missing" .Values.global.configuration.openformsUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.openformsUrl }}/*"
          secret: {{ required ".Values.openforms.configuration.oidcSecret is missing" .Values.openforms.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.openklant.enabled }}
        - clientId: openklant
          name: Open Klant
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.openklantUrl is missing" .Values.global.configuration.openklantUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.openklantUrl }}/*"
          secret: {{ required ".Values.openklant.configuration.oidcSecret is missing" .Values.openklant.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.openinwoner.enabled }}
        - clientId: openinwoner
          name: Open Inwoner
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.openinwonerUrl is missing" .Values.global.configuration.openinwonerUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.openinwonerUrl }}/*"
          secret: {{ required ".Values.openinwoner.configuration.oidcSecret is missing" .Values.openinwoner.configuration.oidcSecret | quote }}
        {{- end }}
        {{- if .Values.kiss.enabled }}
        - clientId: kiss
          name: Kiss
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.kissUrl is missing" .Values.global.configuration.kissUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.kissUrl }}/*"
          secret: {{ required ".Values.kiss.configuration.oidcSecret is missing" .Values.kiss.configuration.oidcSecret | quote }}
          protocolMappers:
            - name: kiss-roles
              protocol: openid-connect
              protocolMapper: oidc-usermodel-client-role-mapper
              config:
                usermodel.clientRoleMapping.clientId: kiss
                multivalued: true
                claim.name: roles
                id.token.claim: true
                access.token.claim: true
                lightweight.claim: true
                userinfo.token.claim: true
                introspection.token.claim: true
        {{- end }}
        {{- if .Values.zac.enabled }}
        - clientId: zac
          name: Zaakafhandelcomponent
          enabled: true
          clientAuthenticatorType: client-secret
          redirectUris:
            - "{{ required ".Values.global.configuration.zacUrl is missing" .Values.global.configuration.zacUrl }}/*"
          webOrigins:
            - "{{ .Values.global.configuration.zacUrl }}/*"
          secret: {{ required ".Values.zac.configuration.oidcSecret is missing" .Values.zac.configuration.oidcSecret | quote }}
          protocolMappers:
            - name: zac-roles
              protocol: openid-connect
              protocolMapper: oidc-usermodel-client-role-mapper
              config:
                usermodel.clientRoleMapping.clientId: zac
                multivalued: true
                claim.name: roles
                id.token.claim: true
                access.token.claim: true
                lightweight.claim: true
                userinfo.token.claim: true
                introspection.token.claim: true
        {{- end }}
      roles:
        realm:
          - name: podiumd-admin
            description: PodiumD Administrator
        {{- if or .Values.kiss.enabled .Values.zac.enabled }}
        client:
          {{- if .Values.kiss.enabled }}
          kiss:
            - name: Redacteur
            - name: Klantcontactmedewerker
          {{- end }}
          {{- if .Values.zac.enabled }}
          zac:
            - name: zaakafhandelcomponent_user
            - name: behandelaar
            - name: beheerder
            - name: coordinator
            - name: recordmanager
            - name: domein_elk_zaaktype
          {{- end }}
        {{- end}}
      {{- if .Values.zac.enabled }}
      components:
        org.keycloak.storage.UserStorageProvider:
          - name: OpenLDAP
            providerId: ldap
            config:
              vendor:
                - other
              connectionUrl:
                - ldap://openldap.openldap:1389
              connectionPooling:
                - true
              bindDn:
                - cn=admin,dc=dimpact-lab,dc=org
              bindCredential:
                - admin
              editMode:
                - WRITABLE
              usersDn:
                - ou=lab3,dc=dimpact-lab,dc=org
              usernameLDAPAttribute:
                - cn
              rdnLDAPAttribute:
                - cn
              uuidLDAPAttribute:
                - entryUUID
              userObjectClasses:
                - inetOrgPerson
              pagination:
                - true
              importEnabled:
                - false
              batchSizeForSync:
                - "1000"
              fullSyncPeriod:
                - "-1"
              changedSyncPeriod:
                - "-1"
            subComponents:
              org.keycloak.storage.ldap.mappers.LDAPStorageMapper:
                - name: groups
                  providerId: group-ldap-mapper
                  config:
                    groups.dn:
                      - ou=lab3,dc=dimpact-lab,dc=org
                    group.object.classes:
                      - groupOfUniqueNames,extensibleObject
                    preserve.group.inheritance:
                      - false
                    membership.ldap.attribute:
                      - uniqueMember
                    mode:
                      - LDAP_ONLY
                    mapped.group.attributes:
                      - description,email
      {{- end }}
      {{- end }}